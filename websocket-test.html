<!DOCTYPE html>
<html>
<head>
    <title>WebSocket –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .row { 
            margin-bottom: 10px; 
        }
        .box { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-bottom: 20px; 
            border-radius: 4px; 
        }
        button {
            padding: 8px 12px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #3e8e41;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            height: 200px;
        }
    </style>
</head>
<body>
    <h1>WebSocket –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
    
    <div class="box">
        <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
        <div id="system-info"></div>
    </div>
    
    <div class="box">
        <h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h2>
        <pre id="browser-info"></pre>
        <button onclick="checkCookies()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cookies</button>
        <button onclick="checkLocalStorage()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
    </div>
    
    <div class="box">
        <h2>3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket</h2>
        <div class="row">
            <input type="text" id="token" placeholder="–í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω" value="">
        </div>
        <div class="row">
            <button onclick="testWebSocketWithURLToken()">–¢–µ—Å—Ç —Å URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º</button>
            <button onclick="testWebSocketWithProtocol()">–¢–µ—Å—Ç —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º</button>
            <button onclick="testWebSocketWithCookie()">–¢–µ—Å—Ç —Å cookie</button>
        </div>
        <div class="row">
            <button onclick="useMMAuthToken()">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookie MMAUTHTOKEN</button>
            <button onclick="testWebSocketWithDefault()">–¢–µ—Å—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
            <button onclick="testWebSocketWithBoth()">–¢–µ—Å—Ç —Å URL –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º</button>
        </div>
        <div class="row">
            <button onclick="testConnectionWithoutToken()">–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞</button>
            <button onclick="inspectLoginResponse()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç /api/login</button>
        </div>
        <pre id="log"></pre>
    </div>
    
    <script>
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ UI
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∏–Ω—Ñ–æ
        function logInfo(message) {
            const infoElement = document.getElementById('browser-info');
            const timestamp = new Date().toLocaleTimeString();
            infoElement.innerHTML += `[${timestamp}] ${message}\n`;
            infoElement.scrollTop = infoElement.scrollHeight;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        function checkSystem() {
            const systemInfo = document.getElementById('system-info');
            
            const webSocketSupported = 'WebSocket' in window;
            const protocol = window.location.protocol;
            const host = window.location.host;
            const localStorageSupported = 'localStorage' in window;
            
            systemInfo.innerHTML = `
                <div>User Agent: <strong>${navigator.userAgent}</strong></div>
                <div>WebSocket –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: <strong>${webSocketSupported}</strong></div>
                <div>localStorage –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: <strong>${localStorageSupported}</strong></div>
                <div>–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª: <strong>${protocol}</strong></div>
                <div>–¢–µ–∫—É—â–∏–π —Ö–æ—Å—Ç: <strong>${host}</strong></div>
                <div>WebSocket URL: <strong>${protocol === 'https:' ? 'wss:' : 'ws:'}//${host}/api/ws</strong></div>
            `;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
            const authToken = localStorage.getItem('auth_token');
            const token = localStorage.getItem('token');
            logInfo(`localStorage —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–∏: ${Object.keys(localStorage)}`);
            logInfo(`auth_token –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${authToken !== null}`);
            logInfo(`token –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${token !== null}`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ cookies
        function checkCookies() {
            logInfo("=== Cookies ===");
            const cookies = document.cookie.split(';');
            if (cookies.length <= 1 && cookies[0] === "") {
                logInfo("Cookies –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
            } else {
                cookies.forEach((cookie) => {
                    const [name, value] = cookie.trim().split('=');
                    logInfo(`${name}: ${value}`);
                    if (name === "MMAUTHTOKEN") {
                        document.getElementById('token').value = value;
                        logInfo(`–ù–∞–π–¥–µ–Ω MMAUTHTOKEN, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞`);
                    }
                });
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage
        function checkLocalStorage() {
            logInfo("=== LocalStorage ===");
            if (localStorage.length === 0) {
                logInfo("LocalStorage –ø—É—Å—Ç");
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    logInfo(`${key}: ${localStorage.getItem(key)}`);
                }
            }
        }
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MMAUTHTOKEN –∏–∑ cookie
        function useMMAuthToken() {
            const cookies = document.cookie.split(';');
            let mmAuthToken = null;
            
            cookies.forEach((cookie) => {
                const [name, value] = cookie.trim().split('=');
                if (name === "MMAUTHTOKEN") {
                    mmAuthToken = value;
                }
            });
            
            if (mmAuthToken) {
                document.getElementById('token').value = mmAuthToken;
                log(`–ù–∞–π–¥–µ–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω MMAUTHTOKEN: ${mmAuthToken}`);
            } else {
                log('–û–®–ò–ë–ö–ê: MMAUTHTOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ cookies');
            }
        }
        
        // –¢–µ—Å—Ç WebSocket —Å —Ç–æ–∫–µ–Ω–æ–º –≤ URL
        function testWebSocketWithURLToken() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('–û–®–ò–ë–ö–ê: –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω');
                return;
            }
            
            log('–¢–µ—Å—Ç WebSocket —Å —Ç–æ–∫–µ–Ω–æ–º –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–µ');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws?token=${token}`;
            
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${wsUrl}`);
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('–£–°–ü–ï–•: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                };
                
                ws.onclose = (event) => {
                    log(`WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
                
                ws.onerror = (error) => {
                    log(`–û–®–ò–ë–ö–ê: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å`);
                    console.error('WebSocket error:', error);
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        log('–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥');
                        ws.close();
                    }
                }, 5000);
            } catch (error) {
                log(`–û–®–ò–ë–ö–ê: ${error.message}`);
            }
        }
        
        // –¢–µ—Å—Ç WebSocket —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
        function testWebSocketWithProtocol() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('–û–®–ò–ë–ö–ê: –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω');
                return;
            }
            
            log('–¢–µ—Å—Ç WebSocket —Å —Ç–æ–∫–µ–Ω–æ–º –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            // –§–æ—Ä–º–∞—Ç—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞: "token.–¢–û–ö–ï–ù" –∏–ª–∏ "token:–¢–û–ö–ï–ù"
            const tokenProtocol = `token.${token}`;
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${wsUrl} —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º ${tokenProtocol}`);
            
            try {
                const ws = new WebSocket(wsUrl, [tokenProtocol]);
                
                ws.onopen = () => {
                    log('–£–°–ü–ï–•: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                };
                
                ws.onclose = (event) => {
                    log(`WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
                
                ws.onerror = (error) => {
                    log(`–û–®–ò–ë–ö–ê: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å`);
                    console.error('WebSocket error:', error);
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        log('–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥');
                        ws.close();
                    }
                }, 5000);
            } catch (error) {
                log(`–û–®–ò–ë–ö–ê: ${error.message}`);
            }
        }
        
        // –¢–µ—Å—Ç WebSocket —Å —Ç–µ–∫—É—â–∏–º–∏ cookies (–±–µ–∑ —Ä—É—á–Ω–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏)
        function testWebSocketWithCookie() {
            log('–¢–µ—Å—Ç WebSocket —Å —Ç–µ–∫—É—â–∏–º–∏ cookies (—Ç–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ cookies –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${wsUrl} –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ cookies)`);
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('–£–°–ü–ï–•: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å cookies —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                };
                
                ws.onclose = (event) => {
                    log(`WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
                
                ws.onerror = (error) => {
                    log(`–û–®–ò–ë–ö–ê: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å`);
                    console.error('WebSocket error:', error);
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        log('–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥');
                        ws.close();
                    }
                }, 5000);
            } catch (error) {
                log(`–û–®–ò–ë–ö–ê: ${error.message}`);
            }
        }
        
        // –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–∫–∏ 401
        function testConnectionWithoutToken() {
            log('–¢–µ—Å—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–æ–∂–∏–¥–∞–µ–º 401)');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('–ù–ï–û–ñ–ò–î–ê–ù–ù–û: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                };
                
                ws.onclose = (event) => {
                    log(`WebSocket –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
                
                ws.onerror = (error) => {
                    log(`–û–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞`);
                    console.error('WebSocket error (expected):', error);
                };
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WebSocket –±–µ–∑ —Ç–æ–∫–µ–Ω–∞: ${error.message}`);
            }
        }
        
        // –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞ /api/login –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–æ–∫–µ–Ω–∞
        function inspectLoginResponse() {
            log('=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ /api/login ===');
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑ localStorage, –µ—Å–ª–∏ –µ—Å—Ç—å
            const savedLoginResponse = localStorage.getItem('lastLoginResponse');
            if (savedLoginResponse) {
                try {
                    const parsedResponse = JSON.parse(savedLoginResponse);
                    log(`–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ª–æ–≥–∏–Ω–∞: ${JSON.stringify(parsedResponse, null, 2)}`);
                    
                    if (parsedResponse.token) {
                        document.getElementById('token').value = parsedResponse.token;
                        log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞: ${parsedResponse.token}`);
                    }
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: ${e.message}`);
                }
            } else {
                log('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ª–æ–≥–∏–Ω–∞ –≤ localStorage');
                
                // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
                log('–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:');
                log(`localStorage.setItem('lastLoginResponse', JSON.stringify(response.data))`);
            }
        }
        
        // –¢–µ—Å—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ—Å—Ç –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function testWebSocketWithDefault() {
            // –¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const testToken = `test_token_${Date.now()}`;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            
            // –í—ã–≤–æ–¥–∏–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:`);
            log(`- –ü—Ä–æ—Ç–æ–∫–æ–ª: ${protocol}`);
            log(`- –•–æ—Å—Ç: ${host}`);
            log(`- –¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω: ${testToken}`);

            try {
                // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                // 1. –ß–µ—Ä–µ–∑ URL-–ø–∞—Ä–∞–º–µ—Ç—Ä (–Ω–∞–∏–±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±)
                const wsUrlWithParam = `${protocol}//${host}/api/ws?token=${testToken}`;
                log(`[–ú–µ—Ç–æ–¥ 1] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–µ: ${wsUrlWithParam.split('?')[0]}`);
                
                const wsTest = new WebSocket(wsUrlWithParam);
                log(`WebSocket –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω (URL –ø–∞—Ä–∞–º–µ—Ç—Ä)`);
                
                wsTest.onopen = function() {
                    log(`‚úÖ [–ú–µ—Ç–æ–¥ 1] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –£–°–ü–ï–®–ù–û —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!`);
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    try {
                        const testMessage = {
                            type: 'ping',
                            payload: { 
                                clientTime: new Date().toISOString(),
                                clientInfo: navigator.userAgent,
                                testId: `test-${Date.now()}`
                            }
                        };
                        wsTest.send(JSON.stringify(testMessage));
                        log(`‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(testMessage)}`);
                    } catch (e) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ${e.message}`);
                    }
                };
                
                wsTest.onerror = function(event) {
                    log(`‚ùå [–ú–µ—Ç–æ–¥ 1] –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${event}`);
                    console.error('WebSocket error:', event);

                    // –ü—Ä–æ–±—É–µ–º –≤—Ç–æ—Ä–æ–π –º–µ—Ç–æ–¥ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ç–æ–∫–µ–Ω–∞ –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ
                    setTimeout(() => {
                        log(`\n[–ú–µ—Ç–æ–¥ 2] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å —Ç–æ–∫–µ–Ω–æ–º –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ...`);
                        const wsUrl2 = `${protocol}//${host}/api/ws`;
                        const wsTest2 = new WebSocket(wsUrl2, [`token=${testToken}`]);
                        
                        wsTest2.onopen = function() {
                            log(`‚úÖ [–ú–µ—Ç–æ–¥ 2] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç–æ–∫–µ–Ω–æ–º –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ –£–°–ü–ï–®–ù–û —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!`);
                        };
                        
                        wsTest2.onerror = function(err) {
                            log(`‚ùå [–ú–µ—Ç–æ–¥ 2] –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º: ${err}`);
                            console.error('WebSocket protocol error:', err);
                        };
                        
                        wsTest2.onclose = function(event) {
                            log(`[–ú–µ—Ç–æ–¥ 2] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                        };
                    }, 1000);
                };
                
                wsTest.onmessage = function(event) {
                    log(`üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${event.data}`);
                    try {
                        const parsed = JSON.parse(event.data);
                        log(`üì® –¢–∏–ø: ${parsed.type}, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${JSON.stringify(parsed.payload)}`);
                    } catch (e) {
                        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON: ${e.message}`);
                    }
                };
                
                wsTest.onclose = function(event) {
                    log(`[–ú–µ—Ç–æ–¥ 1] –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
            } catch (e) {
                log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WebSocket: ${e.message}`);
            }
        }
        
        // –¢–µ—Å—Ç —Å URL –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
        function testWebSocketWithBoth() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('–û–®–ò–ë–ö–ê: –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω');
                return;
            }
            
            log('–¢–µ—Å—Ç WebSocket —Å —Ç–æ–∫–µ–Ω–æ–º –≤ URL –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ');
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            // –§–æ—Ä–º–∞—Ç—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞: "token.–¢–û–ö–ï–ù" –∏–ª–∏ "token:–¢–û–ö–ï–ù"
            const tokenProtocol = `token.${token}`;
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${wsUrl} —Å –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º ${tokenProtocol}`);
            
            try {
                const ws = new WebSocket(wsUrl, [tokenProtocol]);
                
                ws.onopen = () => {
                    log('–£–°–ü–ï–•: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å URL –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                };
                
                ws.onclose = (event) => {
                    log(`WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: –∫–æ–¥=${event.code}, –ø—Ä–∏—á–∏–Ω–∞=${event.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`);
                };
                
                ws.onerror = (error) => {
                    log(`–û–®–ò–ë–ö–ê: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å`);
                    console.error('WebSocket error:', error);
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        log('–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥');
                        ws.close();
                    }
                }, 5000);
            } catch (error) {
                log(`–û–®–ò–ë–ö–ê: ${error.message}`);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = function() {
            checkSystem();
        };
    </script>
</body>
</html> 